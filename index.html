<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Train Scheduler</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        .title {
            /* display: inline; */
            text-align: center;
            color: white;
        }
        .jumbotron {
            background-color: rgb(138, 63, 63);
        }
        h2 {
            background-color: #002ABC;
            color: white;
            font-size: 20px;
        }
        .card {
            border: 2px solid rgb(100, 98, 98);
            margin-bottom: 20px;
        }
        .card-header {
            background-color: rgb(49, 117, 180);
            padding-bottom: 10px;
            margin-bottom: 10px;
            color: white;
        }
        #searchForm {
            padding-left: 10px;
            padding-top: 10px;
        }
        form {
            padding-right: 10px;
            padding-left: 10px;
            padding-bottom: 20px;
        }
        .buttons {
            background-color: grey;
            color: white;
        }
        .form-1 {
            /* height: 100px; */
            resize: both;
            overflow: auto;
        }
        /* .form-1 {
            padding-right: 10px;
            padding-left: 10px;
            padding-bottom: 20px;
        } */
    </style>
</head>

<body>

    <div class="container">
        <div class="jumbotron jumbotron-fluid">

            <span class="glyphicon glyphicon-newspaper"></span>
            <span class="title">

                <h1 class="display-4">
                    <i style="font-size:48px"></i> Train Scheduler</h1>
                <h3></h3>

            </span>
        </div>


        <div class="card">

            <div class="card-header">



                <span id="searchForm" style="font-size:20px"> Current Train Schedule</span>
            </div>
            <div class="form-1">

                <div class="articles-section">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Train Name</th>
                                <th scope="col">Destination</th>
                                <th scope="col">Frequency (min)</th>
                                <th scope="col">Next Arrival</th>
                                <th scope="col">Minutes Away</th>

                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">Trenton Express</th>
                                <td>Trenton</td>
                                <td>25</td>
                                <td>5:35pm</td>
                                <td>10</tr>

                            </tr>


                        </tbody>
                    </table>
                </div>
            </div>
        </div>






        <div class="card">
            <div class="card-header">

                <span id="searchForm" style="font-size:20px"> Add Train</span>
            </div>
            <div class="form-2">

                <form>
                    <div class="form-group">
                        <label for="trainName">Train Name</label>
                        <input type="text" class="form-control" id="trainName" placeholder="" name="trainName">
                    </div>

                    <div class="form-group">
                        <label for="destination">Destination</label>
                        <input type="text" class="form-control" id="destination" placeholder="" name="destination">
                    </div>

                    <div class="form-group">
                        <label for="firstTrain">First Train</label>
                        <input type="time" class="form-control" id="firstTrain" placeholder="" name="firstTrain">
                    </div>

                    <div class="form-group">
                        <label for="frequency">Frequency</label>
                        <input type="number" class="form-control" id="frequency" placeholder="" name="frequency">
                    </div>

                    <button type="submit" id="submitBTN" class="btn btn-default buttons">
                        <span style="font-size:12px"></span>Submit</button>
                </form>


            </div>
        </div>
    </div>
    <br>
    <br>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/4.10.1/firebase.js"></script>

    <!-- JQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>

    <!-- MomentJS -->
    <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>

    <script>
        // console.log(moment('12/13/1901', 'DD/MM/YYYY').format('ddd MMM, DD, YYYY'))
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyCvHMN7v_3MT5BQN-6JvABQ9e8Rv3iJP_c",
            authDomain: "train-scheduler-85af2.firebaseapp.com",
            databaseURL: "https://train-scheduler-85af2.firebaseio.com",
            projectId: "train-scheduler-85af2",
            storageBucket: "train-scheduler-85af2.appspot.com",
            messagingSenderId: "955538316909"
        };
        firebase.initializeApp(config)
        var database = firebase.database()
        var users = database.ref('/users')
        var destination
        var train_dest
        var train_name
        var first_train
        var frequency = $("#frequency").val().trim();
        // Time is 3:30 AM
        // var firstTime = "03:30";
      /*   var firstTime = first_train;
        // First Time (pushed back 1 year to make sure it comes before current time)
        var firstTimeConverted = moment(firstTime, "hh:mm").subtract(1, "years");
        console.log(firstTimeConverted);
        // Current Time
        var currentTime = moment();
        console.log("CURRENT TIME: " + moment(currentTime).format("hh:mm"));
        // Difference between the times
        var diffTime = moment().diff(moment(firstTimeConverted), "minutes");
        console.log("DIFFERENCE IN TIME: " + diffTime);
        // Time apart (remainder)
        var tRemainder = diffTime % frequency;
        console.log(tRemainder);
        // Minute Until Train
        // var tMinutesTillTrain = tFrequency - tRemainder;
        console.log("MINUTES TILL TRAIN: " + tMinutesTillTrain);
        // Next Train
        var nextTrain = moment().add(tMinutesTillTrain, "minutes");
        console.log("ARRIVAL TIME: " + moment(nextTrain).format("hh:mm")) */;
        $('#submitBTN').on('click', function (event) {
            event.preventDefault()
            var name = $("#trainName").val().trim()
            destination = $("#destination").val().trim()
            var firstTrain = $("#firstTrain").val().trim();
            var frequency = $("#frequency").val().trim()
            users.push({
                train_name: name,
                train_dest: destination,
                first_train: firstTrain,
                train_freq: frequency
                //number: number
            })
            retrieve_train()
        })
        function retrieve_train() {
            var first = true
          
            users.orderByChild('train_name').limitToLast(1).on('child_added', function (snap) {
                // console.log(snap.val().train_name)
                if (first === true) {
                 
                    var firstTrain = snap.val().first_train;
                    var trainFreq = snap.val().train_freq;
                    // Normalize firstTrain time
                    var firstTrainNormalized = moment(firstTrain, "hh:mm").subtract(1, "years");
                    // time right now
                    var timeNow = moment();
                    first = false
                    // delta between the current time and time of the first train in minutes
                    var deltaTime = moment().diff(moment(firstTrainNormalized), "minutes");
                    // Time remaining
                    var timeRem = deltaTime % trainFreq;
                    // time in minutes before next train
                     var minBeforeNxtTrain = trainFreq - timeRem;
                    // next train arrival time
                    var nxtArrivalTimeRaw = moment().add(minBeforeNxtTrain, "minutes");
                    var nxtArrivalTime = moment(nxtArrivalTimeRaw).format("hh:mm")
                    console.log("Next Arrival Time: " + nxtArrivalTime);
                    $("tbody").append("<tr><td>" + snap.val().train_name + "</td><td>" + snap.val().train_dest + "</td><td>" + snap.val().train_freq +"</td><td>" + nxtArrivalTime +"</td><td>" + minBeforeNxtTrain )

                }
            })
        }
        // $(".table").append("</td><td>" + train_dest);
    </script>
</body>

</html>